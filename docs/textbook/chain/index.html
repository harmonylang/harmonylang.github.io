
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../2pc/">
      
      
        <link rel="next" href="../actions/">
      
      <link rel="icon" href="../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.7">
    
    
      
        <title>27 Chain Replication - HarmonyDocs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/styles.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chain-replication" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="HarmonyDocs" class="md-header__button md-logo" aria-label="HarmonyDocs" data-md-component="logo">
      
  <img src="../../img/favicon.ico" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            HarmonyDocs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              27 Chain Replication 
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="HarmonyDocs" class="md-nav__button md-logo" aria-label="HarmonyDocs" data-md-component="logo">
      
  <img src="../../img/favicon.ico" alt="logo">

    </a>
    HarmonyDocs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../install/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Textbook
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Textbook
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        1 On Concurrent Programming
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../harmonyintro/" class="md-nav__link">
        2 Hello World! 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../concurrent/" class="md-nav__link">
        3 The Problem of Concurrent Programming 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../harmonymachine/" class="md-nav__link">
        4 The Harmony Virtual Machine 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../critical/" class="md-nav__link">
        5 Critical Sections 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../peterson/" class="md-nav__link">
        6 Peterson's Algorithm 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../method/" class="md-nav__link">
        7 Harmony Methods and Pointers 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../specification/" class="md-nav__link">
        8 Specification 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spinlock/" class="md-nav__link">
        9 Spinlock 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../synch/" class="md-nav__link">
        10 Lock Implementations 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cds/" class="md-nav__link">
        11 Concurrent Data Structures 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../finegrained/" class="md-nav__link">
        12 Fine-Grained Locking 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        13 Testing 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../debugging/" class="md-nav__link">
        14 Debugging 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../condwait/" class="md-nav__link">
        15 Conditional Waiting 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sbs/" class="md-nav__link">
        16 Split Binary Semaphores 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../starvation/" class="md-nav__link">
        17 Starvation 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../monitors/" class="md-nav__link">
        18 Monitors 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deadlock/" class="md-nav__link">
        19 Deadlock 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../actor/" class="md-nav__link">
        20 Actors and Message Passing 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../barrier/" class="md-nav__link">
        21 Barrier Synchronization 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../interrupts/" class="md-nav__link">
        22 Interrupts 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../nonblocking/" class="md-nav__link">
        23 Non-Blocking Synchronization 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../abp/" class="md-nav__link">
        24 Alternating Bit Protocol 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../leader/" class="md-nav__link">
        25 Leader Election 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2pc/" class="md-nav__link">
        26 Transactions and Two Phase Commit 
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        27 Chain Replication 
      </a>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../actions/" class="md-nav__link">
        28 Working with Actions 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../abd/" class="md-nav__link">
        29 Replicated Atomic Read/Write Register 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../consensus/" class="md-nav__link">
        30 Distributed Consensus 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../paxos/" class="md-nav__link">
        31 Paxos 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ns/" class="md-nav__link">
        32 Needham-Schroeder Authentication Protocol 
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../commandline/" class="md-nav__link">
        Using the Command Line
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../values/" class="md-nav__link">
        Harmony Language Details
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hvm/" class="md-nav__link">
        The Harmony Virtual Machine 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../howitworks/" class="md-nav__link">
        How Harmony Works
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../grammar/" class="md-nav__link">
        Simplified Grammar
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../module/" class="md-nav__link">
        Harmony Modules
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../acknowledgments/" class="md-nav__link">
        Acknowledgments
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="chain-replication">Chain Replication</h1>
<p>As you have probably experienced, computers can crash. If you are
running a web service, you may not be able to afford a long outage. If
you are running software that flies a plane, then an outage for any
length of time could lead to a disaster. To deal with service outages
caused by computers crashing, you may want to <em>replicate</em> the service
onto multiple computers. As long as one of the computers survives, the
service remains available.</p>
<p>Besides availability, it is usually important that the replicated
service acts as if it were a single one. This requires that the replicas
of the service coordinate their actions. The <em>Replicated State Machine
Approach</em> is a general approach to do just this. First,
you model your service as a deterministic state machine. The replicas
each run a copy of the state machine, started in the same state. As long
as the replicas handle the same inputs in the same order, determinism
guarantees that they produce the same outputs in the same order.</p>
<div class="highlight"><span class="filename">rsm.hny</span><pre><span></span><code><span class="n">const</span> <span class="n">NREPLICAS</span> <span class="o">=</span> <span class="mi">3</span>     <span class="c1"># number of replicas</span>
<span class="n">const</span> <span class="n">NOPS</span> <span class="o">=</span> <span class="mi">2</span>          <span class="c1"># number of operations</span>

<span class="n">network</span> <span class="o">=</span> <span class="p">[]</span>            <span class="c1"># the network is a queue of messages</span>

<span class="k">def</span> <span class="nf">crash</span><span class="p">():</span>
    <span class="n">stop</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="n">atomically</span> <span class="n">network</span> <span class="o">+=</span> <span class="p">[</span><span class="n">msg</span><span class="p">,]</span>

<span class="k">def</span> <span class="nf">replica</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">immortal</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">immortal</span><span class="p">:</span>
        <span class="n">trap</span> <span class="n">crash</span><span class="p">()</span>
    <span class="n">var</span> <span class="n">delivered</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">atomically</span> <span class="n">when</span> <span class="nb">len</span><span class="p">(</span><span class="n">network</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">delivered</span><span class="p">:</span>
            <span class="n">let</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">network</span><span class="p">[</span><span class="n">delivered</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="n">delivered</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="n">let</span> <span class="n">immortal</span> <span class="o">=</span> <span class="n">choose</span> <span class="p">{</span><span class="mf">1.</span><span class="o">.</span><span class="n">NREPLICAS</span><span class="p">}:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">1.</span><span class="o">.</span><span class="n">NREPLICAS</span><span class="p">}:</span>
        <span class="n">spawn</span> <span class="n">eternal</span> <span class="n">replica</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">==</span> <span class="n">immortal</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">1.</span><span class="o">.</span><span class="n">NOPS</span><span class="p">}:</span>
    <span class="n">spawn</span> <span class="n">client</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</code></pre></div>
<figcaption>Figure 27.1 (<a href=https://harmony.cs.cornell.edu/code/rsm.hny>code/rsm.hny</a>): 
Replicated State Machine </figcaption>

<p><img alt="" src="../figures/rsmspec.png" /></p>
<figcaption>Figure 27.2: The DFA generated by Figure 27.1 when `NOPS=2`
and `NREPLICAS=2`</figcaption>

<p>Figure 27.1 presents a Harmony specification of state machine
replication. We model the state machine as a <em>history</em>: a sequence of
operations. In a replicated state machine, the abstract network maintains this
history as an ordered queue of messages. <code>NOPS</code> clients each place an
operation on the network. The replicas process messages from the ordered network.</p>
<p>All but one of the replicas is allowed to crash. Crashes are modeled as
interrupts, so we use Harmony's <code>trap</code> clause to schedule one.  When
crashing, a replica simply stops. The model chooses one of the replicas
that is not allowed to crash. Of course, a replica does not know whether
it is immortal or not in practice---it should just assume that it is. The
immortality of one of the replicas is only used for modeling the assumptions
we make about the system.</p>
<p>The behavior is captured as before.  Before an operation is added to
the network, a client prints the operation (in this case, its own
identifier). After a replica processes an operation, it prints a
pair consisting of its own identifier and the operation. All replicas
print the same operations in the same order until they crash.
Figure 27.2 shows the allowed behaviors in case there are just
two clients and two replicas.  Because one of the replicas is immortal and
clients do not crash, at least one of the replicas will print both
operations (liveness).  If both do, they do so in the same order (safety).</p>
<p>But in reality the network is not an ordered queue and better modeled as
a set of messages. The trick now is to ensure that all replicas handle
the same requests in the same order and to do so in a way that continues
to work even if some strict subset of replicas crash. <em>Chain
Replication</em> is such a replication protocol. In Chain Replication, the
replicas are organized in a linear chain which may change as replicas crash.
Importantly, at any point in time there is only one <em>head</em> and
one <em>tail</em> replica.</p>
<p>Only the head is allowed to accept new operations from clients.
When it does so, it adds the operation to the end of its history and sends the
history to its successor on the chain. When the direct successor
receives such a history, it makes sure that the history is an extension
of its own and, if so, replaces its own history with the one received.
It then sends the history on to its successor, if any.</p>
<p>When an operation reaches the tail, the operation is what is known as
<em>stable</em> --- it has been reliably ordered and persisted.</p>
<p>So, when a replica fails, its successors should find out about it.
In order for this to work, each replica needs to know who is its
predecessor and who is its successor. So, when a replica fails, 
its neighbors should find out about it. In practice, one server can
detect the failure of another server by pinging it. If a server does
not receive a response to its ping within some maximum amount of time,
then the server considers its peer crashed. Note that this, in general,
is not a safe thing to do---the network or the peer may be temporarily
slow but the peer is not necessarily crashed when the timer
expires.</p>
<p>Nonetheless, we will assume here that failure detection
does not make mistakes and that eventually every failure is detected.
This is called the <em>Fail-Stop</em> failure model, which is distinct from
the often more realistic <em>Crash Failure</em> model where processes can
crash but accurate detection is not available. We will consider that
more realistic failure model in the upcoming chapters.</p>
<div class="highlight"><span class="filename">chain.hny</span><pre><span></span><code><span class="n">const</span> <span class="n">NREPLICAS</span> <span class="o">=</span> <span class="mi">3</span>     <span class="c1"># number of replicas</span>
<span class="n">const</span> <span class="n">NOPS</span> <span class="o">=</span> <span class="mi">2</span>          <span class="c1"># number of operations (or clients)</span>

<span class="n">network</span> <span class="o">=</span> <span class="p">{}</span>            <span class="c1"># the network is a set of messages</span>

<span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>           <span class="c1"># send msg to replica dst</span>
    <span class="n">atomically</span> <span class="n">network</span> <span class="o">|=</span> <span class="p">{</span> <span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">broadcast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>           <span class="c1"># broadcast msg to all</span>
    <span class="n">atomically</span> <span class="k">for</span> <span class="n">dst</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">1.</span><span class="o">.</span><span class="n">NREPLICAS</span><span class="p">}:</span>
        <span class="n">network</span> <span class="o">|=</span> <span class="p">{</span> <span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="n">returns</span> <span class="n">msgs</span><span class="p">:</span>     <span class="c1"># return messages for me</span>
    <span class="n">msgs</span> <span class="o">=</span> <span class="p">{</span> <span class="n">payload</span> <span class="k">for</span> <span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="ow">in</span> <span class="n">network</span> <span class="n">where</span> <span class="p">(</span><span class="n">dst</span> <span class="o">==</span> <span class="bp">self</span><span class="p">)</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">crash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                    <span class="c1"># server &#39;self&#39; is crashing</span>
    <span class="n">broadcast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;crash&quot;</span><span class="p">)</span>        <span class="c1"># notify all other replicas</span>
    <span class="n">stop</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">is_prefix</span><span class="p">(</span><span class="n">hist1</span><span class="p">,</span> <span class="n">hist2</span><span class="p">)</span> <span class="n">returns</span> <span class="n">result</span><span class="p">:</span> <span class="c1"># hist1 is a strict prefix of hist2</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hist1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist2</span><span class="p">))</span> <span class="ow">and</span>
                <span class="nb">all</span><span class="p">(</span><span class="n">hist1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">hist2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">0.</span><span class="o">.</span><span class="n">len</span><span class="p">(</span><span class="n">hist1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">})</span>

<span class="k">def</span> <span class="nf">replica</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">immortal</span><span class="p">):</span>        <span class="c1"># replica &#39;self&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">immortal</span><span class="p">:</span>        <span class="c1"># if not immortal, crash sometime</span>
        <span class="n">trap</span> <span class="n">crash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">var</span> <span class="n">received</span>  <span class="o">=</span> <span class="p">{}</span>              <span class="c1"># messages received</span>
    <span class="n">var</span> <span class="n">requests</span>  <span class="o">=</span> <span class="p">{}</span>              <span class="c1"># client requests received</span>
    <span class="n">var</span> <span class="n">config</span>    <span class="o">=</span> <span class="p">{</span><span class="mf">1.</span><span class="o">.</span><span class="n">NREPLICAS</span><span class="p">}</span>  <span class="c1"># servers in chain configuration</span>
    <span class="n">var</span> <span class="n">hist</span>      <span class="o">=</span> <span class="p">[]</span>              <span class="c1"># history of client requests</span>
    <span class="n">var</span> <span class="n">delivered</span> <span class="o">=</span> <span class="mi">0</span>               <span class="c1"># number requests delivered</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">atomically</span> <span class="n">when</span> <span class="n">exists</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="ow">in</span> <span class="n">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-</span> <span class="n">received</span><span class="p">:</span>
            <span class="n">received</span> <span class="o">|=</span> <span class="p">{</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">payload</span> <span class="p">)</span> <span class="p">}</span>     <span class="c1"># don&#39;t handle twice</span>
            <span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="s2">&quot;client&quot;</span><span class="p">:</span>                 <span class="c1"># received a client request</span>
                <span class="n">requests</span> <span class="o">|=</span> <span class="p">{</span> <span class="n">payload</span> <span class="p">}</span>
            <span class="k">elif</span> <span class="n">payload</span> <span class="o">==</span> <span class="s2">&quot;crash&quot;</span><span class="p">:</span>            <span class="c1"># a server crashed</span>
                <span class="n">config</span> <span class="o">-=</span> <span class="p">{</span> <span class="n">src</span> <span class="p">}</span>               <span class="c1"># remove from configuration</span>
            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span> <span class="o">!=</span> <span class="nb">min</span><span class="p">(</span><span class="n">config</span><span class="p">))</span> <span class="ow">and</span> <span class="n">is_prefix</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
                <span class="n">hist</span> <span class="o">=</span> <span class="n">payload</span>    <span class="c1"># received better hist from predecessor</span>

            <span class="k">if</span> <span class="bp">self</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>     <span class="c1"># I&#39;m the head</span>
                <span class="k">for</span> <span class="n">update</span> <span class="ow">in</span> <span class="n">requests</span> <span class="n">where</span> <span class="n">update</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hist</span><span class="p">:</span>
                    <span class="n">hist</span> <span class="o">+=</span> <span class="p">[</span><span class="n">update</span><span class="p">,]</span>
            <span class="k">if</span> <span class="bp">self</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>     <span class="c1"># I&#39;m the tail, deliver updates</span>
                <span class="k">while</span> <span class="n">delivered</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hist</span><span class="p">[</span><span class="n">delivered</span><span class="p">])</span>
                    <span class="n">delivered</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>                  <span class="c1"># Not tail: send hist to successor</span>
                <span class="n">let</span> <span class="n">successor</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">config</span> <span class="n">where</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="p">):</span>
                    <span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">successor</span><span class="p">,</span> <span class="n">hist</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">broadcast</span><span class="p">(</span><span class="s2">&quot;client&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

<span class="n">let</span> <span class="n">immortal</span> <span class="o">=</span> <span class="n">choose</span> <span class="p">{</span><span class="mf">1.</span><span class="o">.</span><span class="n">NREPLICAS</span><span class="p">}:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">1.</span><span class="o">.</span><span class="n">NREPLICAS</span><span class="p">}:</span>
        <span class="n">spawn</span> <span class="n">eternal</span> <span class="n">replica</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">==</span> <span class="n">immortal</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">1.</span><span class="o">.</span><span class="n">NOPS</span><span class="p">}:</span>
    <span class="n">spawn</span> <span class="n">client</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</code></pre></div>
<figcaption>Figure 27.3 (<a href=https://harmony.cs.cornell.edu/code/chain.hny>code/chain.hny</a>): 
Chain Replication </figcaption>

<p>Figure 27.3 show an implemenation of chain replication.
The network is modeled as a append-only set of messages of the form
<code>(destination, (source, payload))</code>.  When sending, a message is
atomically added to this set. A client broadcasts its operation to
all replicas.</p>
<p>Each replica maintains its own history <code>hist</code> and a chain
configuration <code>config</code>.  The replica executes a loop in which it
receives and atomically handles messages until it crashes.  As before,
one of the replicas cannot crash. Because replicas do not want to
handle the same message twice, each replica maintains a set <code>received</code>
of messages it has already handled.  Each replica then waits for a
message on the network it has not already handled before.</p>
<p>When a replica receives a client request, it adds the request to a
set <code>requests</code> that it maintains.  A replica can only handle such a
request if it is the head, but each replica can eventually become the
head so it should carefully save all requests.  (In theory, it can
remove them as soon as they are on its history.) When a replica receives
a failure notification, it updates its configuration accordingly. When
a non-head replica receives a history that extends its own history, then
the replica adopts the received history.</p>
<p>Next, if a replica is the head, it adds any requests it has received
to its history unless they are already on there. If a replica is the
tail, it "delivers" operations on its history (by printing the operation)
that it has not already delivered. For this, it maintains a counter
<code>delivered</code> that counts the number of delivered requests. Any replica
that is not the tail sends its history to its successor in the chain.</p>
<p>The question is whether chain replication has the same behavior as the
replicated state machine specification of Figure 27.1. This can be
checked using the following two Harmony commands:</p>
<div class="highlight"><pre><span></span><code>$ harmony -o rsm.hfa code/rsm.hny
$ harmony -B rsm.hfa code/chain.hny
</code></pre></div>
<p>The first command outputs the behavior DFA of <code>code/rsm.hny</code> in the
file <code>rsm.hfa</code>. The second command checks that the behavior of
<code>code/chain.hny</code> satisfies the DFA in <code>rsm.hfa</code>. Note that chain
replication does not produce all the possible behaviors of a replicated
state machine, but all its behaviors are valid.</p>
<p>The model has each replica send its entire history each time it extends
its history. This is fine for modeling, but in practice that would not
scale. In practice, a predecessor would set up a TCP connection to its
successor and only send updates to its history along the TCP connection.
Because TCP connections guarantee FIFO order, this would be identical to
the predecessor sending a series of histories, but much more efficient.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2020 - 2023 Robbert van Renesse
    </div>
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.db81ec45.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.a00a7c5e.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>
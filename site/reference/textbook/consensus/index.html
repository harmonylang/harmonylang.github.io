
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.6">
    
    
      
        <title>Distributed Consensus - HarmonyDocs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.a57b2b03.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#distributed-consensus" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="HarmonyDocs" class="md-header__button md-logo" aria-label="HarmonyDocs" data-md-component="logo">
      
  <img src="../../../img/favicon.ico" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            HarmonyDocs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Distributed Consensus
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="HarmonyDocs" class="md-nav__button md-logo" aria-label="HarmonyDocs" data-md-component="logo">
      
  <img src="../../../img/favicon.ico" alt="logo">

    </a>
    HarmonyDocs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/running-harmony/" class="md-nav__link">
        Running a program
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Textbook
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Textbook" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Textbook
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        On Concurrent Programming
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../harmonyintro/" class="md-nav__link">
        Introduction to Harmony
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../concurrent/" class="md-nav__link">
        The Problem of Concurrent Programming
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../harmonymachine/" class="md-nav__link">
        The Harmony Virtual Machine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../critical/" class="md-nav__link">
        Critical Sections
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../peterson/" class="md-nav__link">
        Peterson's Algorithm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../method/" class="md-nav__link">
        Harmony Methods and Pointers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../specification/" class="md-nav__link">
        Specification
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spinlock/" class="md-nav__link">
        Spinlock
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../synch/" class="md-nav__link">
        Lock Implementations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cds/" class="md-nav__link">
        Concurrent Data Structures
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../debugging/" class="md-nav__link">
        Debugging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../condwait/" class="md-nav__link">
        Conditional Waiting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sbs/" class="md-nav__link">
        Split Binary Semaphores
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../starvation/" class="md-nav__link">
        Starvation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../monitors/" class="md-nav__link">
        Monitors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deadlock/" class="md-nav__link">
        Deadlock
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../actor/" class="md-nav__link">
        Actors and Message Passing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../barrier/" class="md-nav__link">
        Barrier Synchronization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../interrupts/" class="md-nav__link">
        Interrupts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../nonblocking/" class="md-nav__link">
        Non-Blocking Synchronization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../abp/" class="md-nav__link">
        Alternating Bit Protocol
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../leader/" class="md-nav__link">
        Leader Election
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2pc/" class="md-nav__link">
        Transactions and Two Phase Commit
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../chain/" class="md-nav__link">
        Chain Replication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../abd/" class="md-nav__link">
        Replicated Atomic Read/Write Register
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Distributed Consensus
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Distributed Consensus
      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#exercises" class="md-nav__link">
    Exercises
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../paxos/" class="md-nav__link">
        Paxos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ns/" class="md-nav__link">
        Needham-Schroeder Authentication Protocol
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Language
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Language" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Language
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../values/" class="md-nav__link">
        Harmony Language Details
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hvm/" class="md-nav__link">
        The Harmony Virtual Machine 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../howitworks/" class="md-nav__link">
        How Harmony Works 
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Library
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Library" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Library
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/alloc/" class="md-nav__link">
        alloc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/bag/" class="md-nav__link">
        bag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/hoare/" class="md-nav__link">
        hoare
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/list/" class="md-nav__link">
        list
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/set/" class="md-nav__link">
        set
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/synch/" class="md-nav__link">
        synch
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Textbook
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../changelog/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../acknowledgments/" class="md-nav__link">
        Acknowledgments
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#exercises" class="md-nav__link">
    Exercises
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="distributed-consensus">Distributed Consensus</h1>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">bag</span>
<span class="n">const</span> <span class="n">F</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">const</span> <span class="n">N</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">F</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">const</span> <span class="n">NROUNDS</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">network</span> <span class="o">=</span> <span class="n">bag</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
<span class="n">let</span> <span class="n">n_zeroes</span> <span class="o">=</span> <span class="n">choose</span><span class="p">({</span> <span class="mi">0</span> <span class="o">..</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">}):</span>
    <span class="n">proposals</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">i</span>  <span class="o">&lt;</span> <span class="o">=</span> <span class="n">n_zeroes</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">{</span> <span class="mi">1</span> <span class="o">..</span> <span class="n">N</span> <span class="p">}</span> <span class="p">]</span>
<span class="n">decisions</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">broadcast</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="n">atomically</span> <span class="n">network</span> <span class="o">=</span> <span class="n">bag</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="nb">round</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">let</span> <span class="n">msgs</span> <span class="o">=</span> <span class="p">{</span> <span class="n">e</span><span class="p">:</span><span class="n">c</span> <span class="k">for</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">e</span><span class="p">):</span><span class="n">c</span> <span class="ow">in</span> <span class="n">network</span> <span class="n">where</span> <span class="n">r</span> <span class="o">==</span> <span class="nb">round</span> <span class="p">}:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">bag</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">msgs</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">processor</span><span class="p">(</span><span class="n">prop</span><span class="p">):</span>
    <span class="n">var</span> <span class="n">proposal</span> <span class="o">=</span> <span class="n">prop</span>
    <span class="n">broadcast</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">proposal</span><span class="p">)</span>
    <span class="k">for</span> <span class="nb">round</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">0.</span><span class="o">.</span><span class="n">NROUNDS</span><span class="err">–</span><span class="mi">1</span><span class="p">}:</span>
        <span class="n">atomically</span> <span class="n">when</span> <span class="n">exists</span> <span class="n">quorum</span> <span class="ow">in</span> <span class="n">receive</span><span class="p">(</span><span class="nb">round</span><span class="p">,</span> <span class="n">N</span> <span class="err">–</span> <span class="n">F</span><span class="p">):</span>
            <span class="n">let</span> <span class="n">count</span> <span class="o">=</span> <span class="p">[</span> <span class="n">bag</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">quorum</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">{</span> <span class="mf">0..1</span> <span class="p">}</span> <span class="p">]:</span>
                <span class="k">assert</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">proposal</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">count</span><span class="p">[</span><span class="n">proposal</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span> <span class="err">–</span> <span class="n">F</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">proposal</span> <span class="ow">in</span> <span class="n">proposals</span>           <span class="c1"># validity</span>
                    <span class="n">possibly</span> <span class="n">proposal</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">proposal</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># can decide</span>
<span class="n">either</span> <span class="n">value</span>
                    <span class="n">decisions</span> <span class="o">|=</span> <span class="p">{</span> <span class="n">proposal</span> <span class="p">}</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">decisions</span><span class="p">)</span>  <span class="o">&lt;</span> <span class="o">=</span> <span class="mi">1</span>             <span class="c1"># agreement</span>
                <span class="n">broadcast</span><span class="p">(</span><span class="nb">round</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">proposal</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">0.</span><span class="o">.</span><span class="n">N</span><span class="err">–</span><span class="mi">1</span><span class="p">}:</span>
    <span class="n">spawn</span> <span class="n">processor</span><span class="p">(</span><span class="n">proposals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div>
<p>Distributed consensus is the problem of having a collection of
processors agree on a single value over a network. For example, in state
machine replication, the state machines have to agree on which operation
to apply next. Without failures, this can be solved using leader
election: first elect a leader, then have that leader decide a value.
But consensus often has to be done in adverse circumstances, for example
in the face of processor failures. In this chapter, we will present a
simple consensus algorithm that can tolerate fewer than <span class="arithmatex">\(1/3^{rd}\)</span> of
processors failing by crashing.</p>
<p>More precisely, constant <code>F</code> contains the maximum number of failures,
and we will assume there are <span class="arithmatex">\(\texttt{N} = 3\texttt{F} + 1\)</span> processors.
Each processor <em>proposes</em> a value, which we assume here to be from the
set { 0, 1 }. By the usual definition of consensus, we want the
following two properties:</p>
<ol>
<li>
<p><em>Validity</em>: a processor can only decide a value that has been
    proposed;</p>
</li>
<li>
<p><em>Agreement</em>: if two processors decide, then they decide the same
    value.</p>
</li>
</ol>
<p>The consensus problem is surprisingly tricky to solve in the face of
processor failures and without making assumptions about how long it
takes to send and receive a message.</p>
<p>presents our algorithm. Besides the network variable, it uses a shared
list of proposals and a shared set of decisions. To reduce the state
space to explore, not all permutations of zeroes and ones are explored.
With 5 processors (<span class="arithmatex">\(\mathtt{F} = 2)\)</span>, say, we only explore the cases
where no processors propose 1, where exactly one processors proposes 1,
and where 2 processors proposes 1. In this particular algorithm, all
messages are broadcast to all processors, so they do not require a
destination address. The invariants we want to maintain on those
variables is that <span class="arithmatex">\(\textit{decisions} \subseteq \textit{proposals}\)</span> and
<span class="arithmatex">\(|\textit{decisions}| \leq 1\)</span>. Since the initial value of <em>decisions</em> is
<span class="arithmatex">\(\emptyset\)</span>, the invariants clearly hold initially.</p>
<p>The <span class="arithmatex">\(\mathtt{N}\)</span> processors go through a sequence of <em>rounds</em> in which
they wait for <span class="arithmatex">\(\texttt{N} - \texttt{F}\)</span> messages, update their state
based on the messages, and broadcast messages containing their new
state. The reason that a processor waits for <span class="arithmatex">\(\texttt{N} - \texttt{F}\)</span>
rather than <code>N</code> messages is because of failures: up to <span class="arithmatex">\(\texttt{F}\)</span>
processors may never send a message and so it would be unwise to wait
for all <span class="arithmatex">\(\texttt{N}\)</span>. You might be tempted to use a timer and time out
on waiting for a particular processor. But how would you initialize that
timer? While we will assume that the network is reliable, there is no
guarantee that messages arrive within a particular time. We call a set
of <span class="arithmatex">\(\texttt{N} - \texttt{F}\)</span> processors a <em>quorum</em>. A quorum must
suffice for the algorithm to make progress.</p>
<p>The state of a processor consists of its current round number and
proposal. Therefore, messages contain a round number and a proposal. To
start things, each processor first broadcasts its initial round number
(0) and proposal. The number of rounds that are necessary to achieve
consensus is not bounded. But Harmony can only check finite models, so
there is a constant <code>NROUNDS</code> that limits the number of rounds. It may
be that no decisions are made, but that does not violate either Validity
or Agreement. We only check that <em>if</em> decisions are made, they satisfy
Validity and Agreement.</p>
<p>In Line 22, a processor waits for <span class="arithmatex">\(\texttt{N} - \texttt{F}\)</span> messages
using the Harmony <strong>select</strong> statement. Since Harmony has to check all
possible executions of the protocol, the <code>receive</code>(<em>round</em>, <span class="arithmatex">\(k\)</span>) method
returns all <em>subbags</em> of messages for the given round that have size
<span class="arithmatex">\(k = \texttt{N} - \texttt{F}\)</span>. The method uses a dictionary
comprehension to filter out all messages for the given <em>round</em> and then
uses the <code>bag.combinations</code> method to find all combinations of size <span class="arithmatex">\(k\)</span>.
The <strong>select</strong> statement waits until there is at least one such
combination and then chooses an element, which is bound to the <em>quorum</em>
variable. The body of the <strong>select</strong> statement is then executed
atomically. This is usually how distributed algorithms are modeled,
because they can only interact through the network. There is no need to
interleave the different processes other than when messages are
delivered. By executing the body atomically, a lot of unnecessary
interleavings are avoided and this reduces the state space that must be
explored by the model checker significantly.</p>
<p>The body of the <strong>select</strong> statement contains the core of the algorithm.
Note that <span class="arithmatex">\(\texttt{N} - \texttt{F} = 2\texttt{F} + 1\)</span>, so that the
number of messages is guaranteed to be odd. Also, because there are only
0 and 1 values, there must exist a majority of zeroes or ones. Variable
<em>count</em>[0] stores the number of zeroes and <code>count</code>[1] stores the
number of ones received in the round. The rules of the algorithm are
simple:</p>
<ul>
<li>
<p>update <em>proposal</em> to be the majority value;</p>
</li>
<li>
<p>if the quorum is unanimous, decide the value.</p>
</li>
</ul>
<p>After that, proceed with the next round.</p>
<p>The <code>possibly</code> statement checks if there exist executions where 0 is
decided and if there exist executions where 1 is decided. Doing so is
useful because the assertions would certainly not fail if no decision is
ever made. Also, it is nice to know that both 0 and 1 can be decided.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">bag</span>
<span class="n">const</span> <span class="n">F</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">const</span> <span class="n">N</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">F</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">const</span> <span class="n">NROUNDS</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">network</span> <span class="o">=</span> <span class="n">bag</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
<span class="n">let</span> <span class="n">n_zeroes</span> <span class="o">=</span> <span class="n">choose</span><span class="p">({</span> <span class="mi">0</span> <span class="o">..</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">}):</span>
    <span class="n">proposals</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">i</span>  <span class="o">&lt;</span> <span class="o">=</span> <span class="n">n_zeroes</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">{</span> <span class="mi">1</span> <span class="o">..</span> <span class="n">N</span> <span class="p">}</span> <span class="p">]</span>
<span class="n">decisions</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">broadcast</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="n">atomically</span> <span class="n">network</span> <span class="o">=</span> <span class="n">bag</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="nb">round</span><span class="p">):</span>
    <span class="n">let</span> <span class="n">msgs</span> <span class="o">=</span> <span class="p">{</span> <span class="n">e</span><span class="p">:</span><span class="n">c</span> <span class="k">for</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">e</span><span class="p">):</span><span class="n">c</span> <span class="ow">in</span> <span class="n">network</span> <span class="n">where</span> <span class="n">r</span> <span class="o">==</span> <span class="nb">round</span> <span class="p">}:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">bag</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">msgs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">N</span> <span class="k">else</span> <span class="p">{</span> <span class="n">msgs</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">processor</span><span class="p">(</span><span class="n">proposal</span><span class="p">):</span>
    <span class="n">broadcast</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">proposal</span><span class="p">)</span>
    <span class="k">for</span> <span class="nb">round</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">0.</span><span class="o">.</span><span class="n">NROUNDS</span><span class="err">–</span><span class="mi">1</span><span class="p">}:</span>
        <span class="n">atomically</span> <span class="n">when</span> <span class="n">exists</span> <span class="n">msgs</span> <span class="ow">in</span> <span class="n">receive</span><span class="p">(</span><span class="nb">round</span><span class="p">):</span>
            <span class="n">let</span> <span class="n">choices</span> <span class="o">=</span> <span class="n">bag</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">msgs</span><span class="p">,</span> <span class="n">N</span> <span class="err">–</span> <span class="n">F</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">quorum</span> <span class="o">=</span> <span class="n">choose</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">count</span> <span class="o">=</span> <span class="p">[</span> <span class="n">bag</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">quorum</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">{</span> <span class="mf">0..1</span> <span class="p">}</span> <span class="p">]:</span>
                <span class="k">assert</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">proposal</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">count</span><span class="p">[</span><span class="n">proposal</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span> <span class="err">–</span> <span class="n">F</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">proposal</span> <span class="ow">in</span> <span class="n">proposals</span>           <span class="c1"># validity</span>
                    <span class="n">possibly</span> <span class="n">proposal</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">proposal</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># can decide</span>
<span class="n">either</span> <span class="n">value</span>
                    <span class="n">decisions</span> <span class="o">|=</span> <span class="p">{</span> <span class="n">proposal</span> <span class="p">}</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">decisions</span><span class="p">)</span>  <span class="o">&lt;</span> <span class="o">=</span> <span class="mi">1</span>             <span class="c1"># agreement</span>
                <span class="n">broadcast</span><span class="p">(</span><span class="nb">round</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">proposal</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">0.</span><span class="o">.</span><span class="n">N</span><span class="err">–</span><span class="mi">1</span><span class="p">}:</span>
    <span class="n">spawn</span> <span class="n">processor</span><span class="p">(</span><span class="n">proposals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div>
<p>While one can run this code within little time for <span class="arithmatex">\(\mathtt{F} = 2\)</span>, for
<span class="arithmatex">\(\mathtt{F} = 3\)</span> the state space to explore is already quite large. One
way to reduce the state space to explore is the following realization:
each processor only considers messages for the round that it is in. If a
message is for an old round, the processor will ignore it; if a message
is for a future round, the processor will buffer it. So one can simplify
the model and have each processor wait for <em>all</em> <code>N</code> messages in a round
instead of <span class="arithmatex">\(\mathtt{N} - \mathtt{F}\)</span>. It would still have to choose to
consider just <span class="arithmatex">\(\mathtt{N} - \mathtt{F}\)</span> out of those <code>N</code> messages, but
executions in which some processors are left behind in all rounds are no
longer considered. It still includes executions where some subset of
<span class="arithmatex">\(\mathtt{N} - \mathtt{F}\)</span> processors only choose each other messages and
essentially ignore the messages of the remaining <code>F</code> processors, so the
resulting model is just as good.</p>
<p>shows the code for this model. Running this with <span class="arithmatex">\(\mathtt{F} = 3\)</span> does
not take very long and this approach is a good blueprint for testing
other round-based protocols (of which there are many).</p>
<h2 id="exercises">Exercises</h2>
<p>The algorithm as given works in the face of crash failures. A more
challenging class to tolerate are <em>arbitrary failures</em> in which up to
<code>F</code> processors may send arbitrary messages, including conflicting
messages to different peers (equivocation). The algorithm can tolerate
those failures if you use <span class="arithmatex">\(\mathtt{N} = 5\mathtt{F} - 1\)</span> processors
instead of <span class="arithmatex">\(\mathtt{N} = 3\mathtt{F} - 1\)</span>. Check that.</p>
<p>In 1983, Michael Ben-Or presented a randomized algorithm that can
tolerate crash failures with just <span class="arithmatex">\(\mathtt{N} = 2\mathtt{F} - 1\)</span>
processors. Implement this algorithm.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../abd/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Replicated Atomic Read/Write Register" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Replicated Atomic Read/Write Register
            </div>
          </div>
        </a>
      
      
        
        <a href="../paxos/" class="md-footer__link md-footer__link--next" aria-label="Next: Paxos" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Paxos
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.fcfe8b6d.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.b1047164.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>

<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.6">
    
    
      
        <title>Harmony Methods and Pointers - HarmonyDocs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.a57b2b03.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#harmony-methods-and-pointers" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="HarmonyDocs" class="md-header__button md-logo" aria-label="HarmonyDocs" data-md-component="logo">
      
  <img src="../../../img/favicon.ico" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            HarmonyDocs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Harmony Methods and Pointers
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="HarmonyDocs" class="md-nav__button md-logo" aria-label="HarmonyDocs" data-md-component="logo">
      
  <img src="../../../img/favicon.ico" alt="logo">

    </a>
    HarmonyDocs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/running-harmony/" class="md-nav__link">
        Running a program
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Textbook
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Textbook" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Textbook
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        On Concurrent Programming
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../harmonyintro/" class="md-nav__link">
        Introduction to Harmony
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../concurrent/" class="md-nav__link">
        The Problem of Concurrent Programming
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../harmonymachine/" class="md-nav__link">
        The Harmony Virtual Machine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../critical/" class="md-nav__link">
        Critical Sections
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../peterson/" class="md-nav__link">
        Peterson's Algorithm
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Harmony Methods and Pointers
      </a>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../specification/" class="md-nav__link">
        Specification
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spinlock/" class="md-nav__link">
        Spinlock
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../synch/" class="md-nav__link">
        Lock Implementations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cds/" class="md-nav__link">
        Concurrent Data Structures
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../debugging/" class="md-nav__link">
        Debugging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../condwait/" class="md-nav__link">
        Conditional Waiting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sbs/" class="md-nav__link">
        Split Binary Semaphores
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../starvation/" class="md-nav__link">
        Starvation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../monitors/" class="md-nav__link">
        Monitors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deadlock/" class="md-nav__link">
        Deadlock
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../actor/" class="md-nav__link">
        Actors and Message Passing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../barrier/" class="md-nav__link">
        Barrier Synchronization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../interrupts/" class="md-nav__link">
        Interrupts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../nonblocking/" class="md-nav__link">
        Non-Blocking Synchronization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../abp/" class="md-nav__link">
        Alternating Bit Protocol
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../leader/" class="md-nav__link">
        Leader Election
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2pc/" class="md-nav__link">
        Transactions and Two Phase Commit
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../chain/" class="md-nav__link">
        Chain Replication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../abd/" class="md-nav__link">
        Replicated Atomic Read/Write Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../consensus/" class="md-nav__link">
        Distributed Consensus
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../paxos/" class="md-nav__link">
        Paxos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ns/" class="md-nav__link">
        Needham-Schroeder Authentication Protocol
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Language
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Language" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Language
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../values/" class="md-nav__link">
        Harmony Language Details
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hvm/" class="md-nav__link">
        The Harmony Virtual Machine 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../howitworks/" class="md-nav__link">
        How Harmony Works 
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Library
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Library" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Library
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/alloc/" class="md-nav__link">
        alloc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/bag/" class="md-nav__link">
        bag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/hoare/" class="md-nav__link">
        hoare
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/list/" class="md-nav__link">
        list
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/set/" class="md-nav__link">
        set
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/synch/" class="md-nav__link">
        synch
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Textbook
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../changelog/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../acknowledgments/" class="md-nav__link">
        Acknowledgments
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="harmony-methods-and-pointers">Harmony Methods and Pointers</h1>
<p>A method <code>m</code> with argument <span class="arithmatex">\(a\)</span> is invoked in its most basic form as
follows (assigning the result to <code>r</code>).</p>
<p><span class="arithmatex">\(r\)</span> = m <span class="arithmatex">\(a\)</span>;</p>
<p>That's right, no parentheses are required. In fact, if you invoke
<code>m</code>(<span class="arithmatex">\(a\)</span>), the argument is (<span class="arithmatex">\(a\)</span>), which is the same as <span class="arithmatex">\(a\)</span>. If you invoke
<code>m()</code>, the argument is <code>()</code>, which is the empty tuple. If you invoke
<code>m</code>(<span class="arithmatex">\(a\)</span>, <span class="arithmatex">\(b\)</span>), the argument is (<span class="arithmatex">\(a\)</span>, <span class="arithmatex">\(b\)</span>), the tuple consisting of
values <span class="arithmatex">\(a\)</span> and <span class="arithmatex">\(b\)</span>.</p>
<p>You may note that all this looks familiar. Indeed, the syntax is the
same as that for dictionaries (see ). Both dictionaries and methods map
Harmony values to Harmony values, and their syntax is indistinguishable.
If <code>f</code> is either a method or a dictionary, and <span class="arithmatex">\(x\)</span> is an arbitrary
Harmony value, then <code>f</code> <span class="arithmatex">\(x\)</span>, <code>f</code>(<span class="arithmatex">\(x\)</span>), and <code>f</code>[<span class="arithmatex">\(x\)</span>] are all the same
expression in Harmony.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">P_enter</span><span class="p">(</span><span class="n">pm</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="n">pm</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">pm</span><span class="o">-&gt;</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">1</span> <span class="err">–</span> <span class="n">pid</span>
    <span class="k">await</span> <span class="p">(</span><span class="ow">not</span> <span class="n">pm</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">[</span><span class="mi">1</span> <span class="err">–</span> <span class="n">pid</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">turn</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">P_exit</span><span class="p">(</span><span class="n">pm</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="n">pm</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">P_mutex</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span> <span class="o">.</span><span class="n">turn</span><span class="p">:</span> <span class="n">choose</span><span class="p">({</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">}),</span> <span class="o">.</span><span class="n">flags</span><span class="p">:</span> <span class="p">[</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span> <span class="p">]</span> <span class="p">}</span>
<span class="c1">#### The code above can go into its own Harmony module ####</span>
<span class="n">sequential</span> <span class="n">mutex</span>
<span class="n">mutex</span> <span class="o">=</span> <span class="n">P_mutex</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">choose</span><span class="p">({</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span> <span class="p">}):</span>
        <span class="n">P_enter</span><span class="p">(</span><span class="err">?</span><span class="n">mutex</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="nd">@cs</span><span class="p">:</span> <span class="k">assert</span> <span class="n">countLabel</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">P_exit</span><span class="p">(</span><span class="err">?</span><span class="n">mutex</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<span class="n">spawn</span> <span class="n">thread</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">spawn</span> <span class="n">thread</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<p>Harmony does not have a <strong>return</strong> statement. (You can assign a return
value to a method by setting the <em>result</em> variable.) Neither does it
support <strong>break</strong> or <strong>continue</strong> statements in loops. One reason for
their absence is that, particularly in concurrent programming, such
control flow directions are highly error-prone. It's too easy to forget
to, say, release a lock when returning a value in the middle of a
method, a major source of bugs in practice.</p>
<p>Harmony is not an object-oriented language like Python is. In Python you
can pass a reference to an object to a method, and that method can then
update the object. In Harmony, it is also sometimes convenient to have a
method update a shared variable specified as an argument. For this, as
mentioned in , each shared variable has an <em>address</em>, itself a Harmony
value. If <span class="arithmatex">\(x\)</span> is a shared variable, then the expression ?<span class="arithmatex">\(x\)</span> is the
address of <span class="arithmatex">\(x\)</span>. If a variable contains an address, we call that variable
a <em>pointer</em>. If <span class="arithmatex">\(p\)</span> is a pointer to a shared variable, then the
expression <code>!</code><span class="arithmatex">\(p\)</span> is the value of the shared variable. In particular,
<code>!?</code><span class="arithmatex">\(x\)</span> == <span class="arithmatex">\(x\)</span>. This is similar to how C pointers work (<code>*&amp;</code><span class="arithmatex">\(x\)</span> == <span class="arithmatex">\(x\)</span>).</p>
<p>Often, pointers point to dictionaries, and so if <span class="arithmatex">\(p\)</span> is such a pointer,
then <span class="arithmatex">\((!p).\mathtt{field}\)</span> would evaluate to the specified field in the
dictionary. Note that the parentheses in this expression are needed, as
<code>!</code><em>p</em><code>.field</code> would wrongly evaluate <code>!</code>(<em>p</em><code>.field</code>).
<span class="arithmatex">\((!p).\mathtt{field}\)</span> is such a common expression that, like C, Harmony
supports the shorthand <span class="arithmatex">\(p-\)</span><span class="arithmatex">\(&gt;\)</span><code>field</code>, which greatly improves
readability.</p>
<p>again shows Peterson's algorithm, but this time with methods defined to
enter and exit the critical section. The name <em>mutex</em> is often used to
denote a variable or value that is used for mutual exclusion. <code>P_mutex</code>
is a method that returns a "mutex," which, in this case, is a dictionary
that contains Peterson's Algorithm's shared memory state: a turn
variable and two flags. Both methods <code>P_enter</code> and <code>P_exit</code> take two
arguments: a pointer to a mutex and the thread identifier (0 or 1).
<span class="arithmatex">\(\mathit{pm}\)</span>-&gt;<span class="arithmatex">\(\mathtt{turn}\)</span> is the value of the <code>.turn</code>
key in the dictionary that <em>pm</em> points to.</p>
<p>You can put the first three methods in its own Harmony source file and
include it using the Harmony <code>import</code> statement. This would make the
code usable by multiple applications.</p>
<p>Finally, methods can have local variables. Different from Python,
Harmony local variables must be explicitly bound within a scope. Method
variables are either mutable or immutable. The arguments to a method and
the bound variable (or variables) within a <code>for</code> statement are
immutable; the variable <em>result</em> is mutable. Using the <code>var</code> statement,
new mutable local variables can be declared. For example, <code>var</code> <span class="arithmatex">\(x = 3\)</span>
declares a new mutable local variable <span class="arithmatex">\(x\)</span>. The <code>let</code> statement allows
declaring new immutable local variables. For example: <code>let</code> <span class="arithmatex">\(x = 3\)</span>: <span class="arithmatex">\(y\)</span>
<span class="arithmatex">\(+\)</span><span class="arithmatex">\(=\)</span> <span class="arithmatex">\(x\)</span> adds 3 to the global variable <span class="arithmatex">\(y\)</span>. See for more information.</p>
<div class="highlight"><pre><span></span><code><span class="n">const</span> <span class="n">FIFO</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">CLOCK</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span> <span class="o">.</span><span class="n">entries</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,]</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span> <span class="o">.</span><span class="n">recent</span><span class="p">:</span> <span class="p">{},</span> <span class="o">.</span><span class="n">hand</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="n">misses</span><span class="p">:</span> <span class="mi">0</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">ref</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">hand</span><span class="p">]</span> <span class="ow">in</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">recent</span><span class="p">:</span>
            <span class="n">clock</span><span class="o">-&gt;</span><span class="n">recent</span> <span class="err">–</span><span class="o">=</span> <span class="p">{</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">hand</span><span class="p">]}</span>
            <span class="n">clock</span><span class="o">-&gt;</span><span class="n">hand</span> <span class="o">=</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">hand</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">)</span>
        <span class="n">clock</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">hand</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">clock</span><span class="o">-&gt;</span><span class="n">hand</span> <span class="o">=</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">hand</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">)</span>
        <span class="n">clock</span><span class="o">-&gt;</span><span class="n">misses</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">FIFO</span><span class="p">:</span>
        <span class="n">clock</span><span class="o">-&gt;</span><span class="n">recent</span> <span class="o">|=</span> <span class="p">{</span><span class="n">x</span><span class="p">}</span>
<span class="n">clock3</span><span class="p">,</span> <span class="n">clock4</span><span class="p">,</span> <span class="n">refs</span> <span class="o">=</span> <span class="n">CLOCK</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">CLOCK</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="p">[</span> <span class="p">]</span>
<span class="n">const</span> <span class="n">VALUES</span> <span class="o">=</span> <span class="p">{</span> <span class="mf">1..5</span> <span class="p">}</span>
<span class="n">var</span> <span class="n">last</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">1..100</span><span class="p">}:</span>
    <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">i</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="n">choose</span><span class="p">(</span><span class="n">VALUES</span> <span class="err">–</span> <span class="n">last</span><span class="p">):</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="n">refs</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span><span class="p">,]</span>
        <span class="n">ref</span><span class="p">(</span><span class="err">?</span><span class="n">clock3</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span> <span class="n">ref</span><span class="p">(</span><span class="err">?</span><span class="n">clock4</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">clock4</span><span class="o">.</span><span class="n">misses</span>  <span class="o">&lt;</span> <span class="o">=</span> <span class="n">clock3</span><span class="o">.</span><span class="n">misses</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">}</span>
</code></pre></div>
<p>If you are ready to learn about how locks are implemented in practice,
you can now skip the rest of this chapter. But if you would like to see
a cool example of using the concepts introduced in this chapter, hang on
for a sequential Harmony program that finds anomalies in page
replacement algorithms. In 1969, Béláady et al. published a
paper that showed that making a cache larger does not
necessarily lead to a higher hit ratio. He showed this for a scenario
using a FIFO replacement policy when the cache is full. The program in
will find exactly the same scenario if you define <code>FIFO</code> to be <strong>True</strong>.
Moreover, if you define <code>FIFO</code> to be <strong>False</strong>, it will find a scenario
for the CLOCK replacement policy, often used in modern
operating systems.</p>
<p>In this program, <code>CLOCK</code> maintains the state of a cache (in practice,
typically pages in memory). The set <code>recent</code> maintains whether an access
to the cache for a particular reference was recent or not. (It is not
used if <code>FIFO</code> is <strong>True</strong>.) The integer <code>misses</code> maintains the number
of cache misses. Method <code>ref</code>(<em>ck</em>, <span class="arithmatex">\(x\)</span>) is invoked when <span class="arithmatex">\(x\)</span> is
referenced and checked against the cache <em>ck</em>.</p>
<p>The program declares two caches: one with 3 entries (<em>clock3</em>) and one
with 4 entries (<em>clock4</em>). The interesting part is in the last block of
code. It runs every sequence of references of up to 100 entries, using
references in the range 1 through 5. Note that all the constants chosen
in this program (3, 4, 5, 100) are the result of some
experimentation---you can try other ones. To reduce the search space,
the first four references are pinned to 1, 2, 3, and 4. Further reducing
the search space, the program never repeats the same reference twice in
a row (using the local variable <code>last</code>).</p>
<p>The two things to note here is the use of the <strong>choose</strong> expression and
the <strong>assert</strong> statement. Using <code>choose</code> we are able to express
searching through all possible strings of references without a
complicated nested iteration. Using <code>assert</code> we are able to express the
anomaly we are looking for.</p>
<p>In case you want to check if you get the right results. For <code>FIFO</code>, the
program finds (in a few minutes) the same anomaly that Bélády et al.
found: 1 2 3 4 1 2 5 1 2 3 4 5. For the <code>CLOCK</code> algorithm the program
actually finds a shorter reference string: 1 2 3 4 2 1 2 5 1 2.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../peterson/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Peterson&#39;s Algorithm" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Peterson's Algorithm
            </div>
          </div>
        </a>
      
      
        
        <a href="../specification/" class="md-footer__link md-footer__link--next" aria-label="Next: Specification" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Specification
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.fcfe8b6d.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.b1047164.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>

<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.6">
    
    
      
        <title>Barrier Synchronization - HarmonyDocs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.a57b2b03.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#barrier-synchronization" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="HarmonyDocs" class="md-header__button md-logo" aria-label="HarmonyDocs" data-md-component="logo">
      
  <img src="../../../img/favicon.ico" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            HarmonyDocs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Barrier Synchronization
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="HarmonyDocs" class="md-nav__button md-logo" aria-label="HarmonyDocs" data-md-component="logo">
      
  <img src="../../../img/favicon.ico" alt="logo">

    </a>
    HarmonyDocs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/running-harmony/" class="md-nav__link">
        Running a program
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Textbook
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Textbook" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Textbook
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        On Concurrent Programming
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../harmonyintro/" class="md-nav__link">
        Introduction to Harmony
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../concurrent/" class="md-nav__link">
        The Problem of Concurrent Programming
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../harmonymachine/" class="md-nav__link">
        The Harmony Virtual Machine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../critical/" class="md-nav__link">
        Critical Sections
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../peterson/" class="md-nav__link">
        Peterson's Algorithm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../method/" class="md-nav__link">
        Harmony Methods and Pointers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../specification/" class="md-nav__link">
        Specification
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spinlock/" class="md-nav__link">
        Spinlock
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../synch/" class="md-nav__link">
        Lock Implementations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cds/" class="md-nav__link">
        Concurrent Data Structures
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../debugging/" class="md-nav__link">
        Debugging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../condwait/" class="md-nav__link">
        Conditional Waiting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sbs/" class="md-nav__link">
        Split Binary Semaphores
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../starvation/" class="md-nav__link">
        Starvation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../monitors/" class="md-nav__link">
        Monitors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deadlock/" class="md-nav__link">
        Deadlock
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../actor/" class="md-nav__link">
        Actors and Message Passing
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Barrier Synchronization
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Barrier Synchronization
      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#exercises" class="md-nav__link">
    Exercises
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../interrupts/" class="md-nav__link">
        Interrupts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../nonblocking/" class="md-nav__link">
        Non-Blocking Synchronization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../abp/" class="md-nav__link">
        Alternating Bit Protocol
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../leader/" class="md-nav__link">
        Leader Election
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2pc/" class="md-nav__link">
        Transactions and Two Phase Commit
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../chain/" class="md-nav__link">
        Chain Replication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../abd/" class="md-nav__link">
        Replicated Atomic Read/Write Register
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../consensus/" class="md-nav__link">
        Distributed Consensus
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../paxos/" class="md-nav__link">
        Paxos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ns/" class="md-nav__link">
        Needham-Schroeder Authentication Protocol
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Language
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Language" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Language
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../values/" class="md-nav__link">
        Harmony Language Details
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hvm/" class="md-nav__link">
        The Harmony Virtual Machine 
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../howitworks/" class="md-nav__link">
        How Harmony Works 
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Library
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Library" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Library
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/alloc/" class="md-nav__link">
        alloc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/bag/" class="md-nav__link">
        bag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/hoare/" class="md-nav__link">
        hoare
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/list/" class="md-nav__link">
        list
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/set/" class="md-nav__link">
        set
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../library/synch/" class="md-nav__link">
        synch
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Textbook
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../changelog/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../acknowledgments/" class="md-nav__link">
        Acknowledgments
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#exercises" class="md-nav__link">
    Exercises
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="barrier-synchronization">Barrier Synchronization</h1>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">synch</span> <span class="kn">import</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">put</span><span class="p">,</span> <span class="n">get</span>
<span class="n">const</span> <span class="n">NTHREADS</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">const</span> <span class="n">NROUNDS</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">sequential</span> <span class="nb">round</span>
<span class="nb">round</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,]</span> <span class="o">*</span> <span class="n">NTHREADS</span>
<span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">Queue</span><span class="p">(),]</span> <span class="o">*</span> <span class="n">NTHREADS</span>

<span class="k">def</span> <span class="nf">thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">1.</span><span class="o">.</span><span class="n">NROUNDS</span><span class="p">}:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">0.</span><span class="o">.</span><span class="n">NTHREADS</span><span class="err">–</span><span class="mi">1</span><span class="p">}</span> <span class="n">where</span> <span class="n">i</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">put</span><span class="p">(</span><span class="err">?</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">0.</span><span class="o">.</span><span class="n">NTHREADS</span><span class="err">–</span><span class="mi">1</span><span class="p">}</span> <span class="n">where</span> <span class="n">i</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">get</span><span class="p">(</span><span class="err">?</span><span class="n">q</span><span class="p">[</span><span class="bp">self</span><span class="p">])</span>
        <span class="nb">round</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">round</span><span class="p">)</span> <span class="err">–</span> <span class="nb">min</span><span class="p">(</span><span class="nb">round</span><span class="p">))</span>  <span class="o">&lt;</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">0.</span><span class="o">.</span><span class="n">NTHREADS</span><span class="err">–</span><span class="mi">1</span><span class="p">}:</span>
    <span class="n">spawn</span> <span class="n">thread</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</code></pre></div>
<p>Barrier synchronization is a problem that comes up in high-performance
parallel computing. It is used, among others, for scalable simulation. A
barrier is almost the opposite of a critical section: the intention is
to get a group of threads to run some code at the same time, instead of
having them execute it one at a time. More precisely, with barrier
synchronization the threads execute in rounds. Between each round there
is a so-called <em>barrier</em> where threads wait until all threads have
completed the previous round, before they start the next one. For
example, in an iterative matrix algorithm, the matrix may be cut up into
fragments. During a round, the threads run concurrently, one for each
fragment. The next round is not allowed to start until all threads have
completed processing their fragment.</p>
<p>Blocking queues work well for implementing barrier synchronization.
shows an example. There is a queue for each of the <code>N</code> threads. Before
thread <span class="arithmatex">\(i\)</span> enters a round, it first sends a message to every other
thread and then waits until it receives a message from every other
thread. In this simple case, each message contains <code>None</code>, but in
practice useful information may be exchanged between the threads.</p>
<p>The <em>round</em> array is kept to check the correctness of this approach.
Each thread increments its entry every time it enters a round. If the
algorithm is correct, it can never be that two threads are more than one
round apart.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">synch</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">Barrier</span><span class="p">(</span><span class="n">limit</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">.</span><span class="n">limit</span><span class="p">:</span> <span class="n">limit</span><span class="p">,</span> <span class="o">.</span><span class="n">stage</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="n">mutex</span><span class="p">:</span> <span class="n">Lock</span><span class="p">(),</span>
        <span class="o">.</span><span class="n">empty</span><span class="p">:</span> <span class="n">Condition</span><span class="p">(),</span> <span class="o">.</span><span class="n">full</span><span class="p">:</span> <span class="n">Condition</span><span class="p">()</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">enter</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
    <span class="n">acquire</span><span class="p">(</span><span class="err">?</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">stage</span>  <span class="o">&gt;</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">:</span>     <span class="c1"># wait for car to empty out</span>
        <span class="n">wait</span><span class="p">(</span><span class="err">?</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">,</span> <span class="err">?</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">)</span>
    <span class="n">b</span><span class="o">-&gt;</span><span class="n">stage</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">stage</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">:</span>         <span class="c1"># wait for car to fill up</span>
        <span class="k">while</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">stage</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">:</span>
            <span class="n">wait</span><span class="p">(</span><span class="err">?</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">full</span><span class="p">,</span> <span class="err">?</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>                             
        <span class="n">notifyAll</span><span class="p">(</span><span class="err">?</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">full</span><span class="p">)</span>         <span class="c1"># car is full and ready to go</span>
    <span class="n">release</span><span class="p">(</span><span class="err">?</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
    <span class="n">acquire</span><span class="p">(</span><span class="err">?</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">limit</span>  <span class="o">&lt;</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">stage</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">)</span>
    <span class="n">b</span><span class="o">-&gt;</span><span class="n">stage</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">stage</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">):</span>  <span class="c1"># everybody left</span>
        <span class="n">b</span><span class="o">-&gt;</span><span class="n">stage</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">notifyAll</span><span class="p">(</span><span class="err">?</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">)</span>        <span class="c1"># let next group in</span>
    <span class="n">release</span><span class="p">(</span><span class="err">?</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">barrier</span>
<span class="n">const</span> <span class="n">NROUNDS</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">const</span> <span class="n">NTHREADS</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">barr</span> <span class="o">=</span> <span class="n">barrier</span><span class="o">.</span><span class="n">Barrier</span><span class="p">(</span><span class="n">NTHREADS</span><span class="p">)</span>
<span class="n">sequential</span> <span class="nb">round</span>
<span class="nb">round</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,]</span> <span class="o">*</span> <span class="n">NTHREADS</span>

<span class="k">def</span> <span class="nf">thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">0.</span><span class="o">.</span><span class="n">NROUNDS</span><span class="err">–</span><span class="mi">1</span><span class="p">}:</span>
        <span class="n">barrier</span><span class="o">.</span><span class="n">enter</span><span class="p">(</span><span class="err">?</span><span class="n">barr</span><span class="p">)</span>
        <span class="nb">round</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
        <span class="k">assert</span> <span class="p">{</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">round</span> <span class="n">where</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">None</span> <span class="p">}</span> <span class="o">==</span> <span class="p">{</span> <span class="n">r</span> <span class="p">}</span>
        <span class="nb">round</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">barrier</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="err">?</span><span class="n">barr</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">0.</span><span class="o">.</span><span class="n">NTHREADS</span><span class="err">–</span><span class="mi">1</span><span class="p">}:</span>
    <span class="n">spawn</span> <span class="n">thread</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</code></pre></div>
<p>More generally, barrier synchronization can be abstracted as follows. We
want to create a <code>Barrier</code><span class="arithmatex">\((n)\)</span> object, with operations <code>enter()</code> and
<code>exit()</code>. It is helpful to use a roller coaster car with <span class="arithmatex">\(n\)</span> seats as a
metaphor:</p>
<ul>
<li>
<p>the car cannot contain more than <span class="arithmatex">\(n\)</span> people;</p>
</li>
<li>
<p>the car won't take off until <span class="arithmatex">\(n\)</span> people are in the car;</p>
</li>
<li>
<p>no new people can enter the car until all <span class="arithmatex">\(n\)</span> people have left it.</p>
</li>
</ul>
<p>Notice there are two different waiting conditions:</p>
<ol>
<li>
<p>waiting for the car to empty out;</p>
</li>
<li>
<p>waiting for the car to fill up.</p>
</li>
</ol>
<p>But this poses a complication. Suppose, for example, that there are two
seats in the car, and there is one person in the car. Does that mean
that the car is not yet full, or not yet empty? We have to distinguish
those situations. To this end, it is useful to think of the car as going
through <span class="arithmatex">\(2 \cdot n\)</span> stages:</p>
<ul>
<li>
<p>Stage 0: the car is empty;</p>
</li>
<li>
<p>Stage <span class="arithmatex">\(1 ... n-1\)</span>: the car is filling up;</p>
</li>
<li>
<p>Stage <span class="arithmatex">\(n\)</span>: the car is full;</p>
</li>
<li>
<p>Stage <span class="arithmatex">\(n+1 ... 2n - 1\)</span>: the car is emptying out.</p>
</li>
</ul>
<p>shows code that implements barrier synchronization using these stages.
Method <code>enter</code>() has two <code>wait</code> loops, one for each waiting condition.
This is sometimes called <em>double turnstile</em>. Each loop uses a different
condition variable. The first loop waits until the car has emptied out,
while the second waits for the car to fill up. is a test program. The
threads check that all threads within the barrier are in the same round.</p>
<h2 id="exercises">Exercises</h2>
<p>Implement barrier synchronization for <code>N</code> threads with just three binary
semaphores. Busy waiting is not allowed. Can you implement barrier
synchronization with two binary semaphores? (As always, the Little Book
of Semaphores is a good resource for solving synchronization
problems with semaphores. Look for the <em>double turnstile</em> solution.)</p>
<p>Imagine a pool hall with <code>N</code> tables. A table is <em>full</em> from the time
there are two players until both players have left. When someone
arrives, they can join a table that is not full, preferably one that has
a player ready to start playing. Implement a simulation of such a pool
hall.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../actor/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Actors and Message Passing" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Actors and Message Passing
            </div>
          </div>
        </a>
      
      
        
        <a href="../interrupts/" class="md-footer__link md-footer__link--next" aria-label="Next: Interrupts" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Interrupts
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.fcfe8b6d.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.b1047164.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>